# EC2ã®å®Ÿç‰©ã¨ã™ã‚Šåˆã‚ã›
# ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚„é–¢é€£ã‚µãƒ–ãƒãƒƒãƒˆã®è¨­å®šãªã©ã€æŠœã‘ãŒãªã„ã‹ç¢ºèª
# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã¿ã¦å¿…è¦å±æ€§ã€ãã®ä»–ã®å±æ€§ã‚’è¦‹ã‚‹
# https://docs.aws.amazon.com/AWSCloudFormation/latest/TemplateReference/aws-resource-ec2-internetgateway.html

AWSTemplateFormatVersion: '2010-09-09'
Description: CloudFormation Template for VPC, Subnets, EC2 (Bastion + Web), RDS, Route53

Parameters:
# Default: 10.0.0.0/16 â€¦ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯ã€Œ10.0.0.0/16ã€
# Description â€¦ ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª¬æ˜ï¼ˆVPCã®CIDRãƒ–ãƒ­ãƒƒã‚¯ï¼‰
  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
    Description: CIDR block for the VPC

  PublicSubnetCidr:
    Type: String
    Default: 10.0.0.0/20
    Description: CIDR block for the public subnet

# Description: EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ä½¿ç”¨ã™ã‚‹AMI IDã‚’æŒ‡å®š
  LatestAmiId:
    Type: String
    Description: The AMI ID to use for EC2 instances

# Description: EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸SSHæ¥ç¶šã™ã‚‹ãŸã‚ã®ã‚­ãƒ¼ãƒšã‚¢åã‚’æŒ‡å®š
# ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ã€CloudFormation ã‚¹ã‚¿ãƒƒã‚¯ä½œæˆæ™‚ã«**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã™ã‚‹ã€ŒEC2ã‚­ãƒ¼ãƒšã‚¢åã€**ã‚’å—ã‘å–ã‚‹
  KeyPairName:
    Type: String
    Description: EC2 KeyPair Name for SSH access

# Resources:-----------------------------------------------------------------------------------
Resources:

# VPC:-----------------------------------------------------------------------------------
  TsStudyRecordVPC:
    Type: AWS::EC2::VPC
# Properties:
#   CidrBlock: !Ref VpcCidr â€¦ VPCã®CIDRãƒ–ãƒ­ãƒƒã‚¯ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼‰
#   !Ref ã¯ã€ŒæŒ‡å®šã—ãŸãƒªã‚½ãƒ¼ã‚¹åã¾ãŸã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã‚’å‚ç…§ã—ã¦ã€ãã®å€¤ã‚’å–å¾—ã™ã‚‹ã€ãŸã‚ã®é–¢æ•°
#   EnableDnsSupport: true â€¦ DNSè§£æ±ºã‚’æœ‰åŠ¹åŒ–
#   EnableDnsHostnames: true â€¦ DNSãƒ›ã‚¹ãƒˆåã‚’æœ‰åŠ¹åŒ–
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: ts-study-record-vpc

# Internet Gateway:-----------------------------------------------------------------------------------
  IGWTsStudyRecord:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: igw-ts-study-record

# AttachIGW:-----------------------------------------------------------------------------------
# TsStudyRecordVPCã¨IGWTsStudyRecordã‚’ã‚¢ã‚¿ãƒƒãƒã—ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆé€šä¿¡ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
  AttachIGW:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref TsStudyRecordVPC
      InternetGatewayId: !Ref IGWTsStudyRecord

# Subnet:-----------------------------------------------------------------------------------
  # Public Subnet 1 (ap-northeast-1a)
#  MapPublicIpOnLaunch: true
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref TsStudyRecordVPC
      CidrBlock: !Ref PublicSubnetCidr
      # ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã™ã‚‹ã¨ãã«è‡ªå‹•ã§ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’å‰²ã‚Šå½“ã¦ã‚‹
      MapPublicIpOnLaunch: true
      AvailabilityZone: ap-northeast-1a
      Tags:
        - Key: Name
          Value: public-ts-study-record-subnet

  # Private Subnet 1 (ap-northeast-1a)
  # MapPublicIpOnLaunch: false ã‚µãƒ–ãƒãƒƒãƒˆå†…ã«ä½œæˆã•ã‚Œã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«è‡ªå‹•çš„ã«ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’å‰²ã‚Šå½“ã¦ãªã„
  PrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref TsStudyRecordVPC
      CidrBlock: 10.0.64.0/20
      AvailabilityZone: ap-northeast-1a
      # ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã™ã‚‹ã¨ãã«è‡ªå‹•ã§ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’å‰²ã‚Šå½“ã¦ã‚‹
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: private-ts-study-record-subnet

  # Private Subnet 2 (ap-northeast-1c)
  PrivateSubnetC:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref TsStudyRecordVPC
      CidrBlock: 10.0.80.0/20
      AvailabilityZone: ap-northeast-1c
      # ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã™ã‚‹ã¨ãã«è‡ªå‹•ã§ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’å‰²ã‚Šå½“ã¦ã‚‹
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: private02-ts-study-record-subnet

# Subnet Group:-----------------------------------------------------------------------------------
  # RDS Subnet Groupï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆ 2ã¤ã«ã™ã‚‹ã®ãŒæ¨å¥¨ï¼‰
  RDSSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for private RDS
      SubnetIds:
        - !Ref PrivateSubnetA
        - !Ref PrivateSubnetC
      Tags:
        - Key: Name
          Value: PrivateRDSSubnetGroup

# Route Table:-----------------------------------------------------------------------------------
  # Public Route Table
  PublicRouteTable:
  # VPC å†…ã§ä½¿ã†Publicãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref TsStudyRecordVPC
      Tags:
        - Key: Name
          Value:  rt-public-ts-study-record

  # Default Route to IGW
  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachIGW # ä½œæˆé †åºã®åˆ¶å¾¡
    Properties:
      RouteTableId: !Ref PublicRouteTable # PublicRouteTableã«ãƒ«ãƒ¼ãƒˆã‚’è¨­å®š
      # ã€Œã“ã®å®›å…ˆã¸ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã¯ã©ã“ã«é€ã‚‹ã‹ã€ã‚’å®šç¾©ã€‚ä¸»ã«ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ï¼ˆVPC â†’ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆï¼‰ç”¨
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref IGWTsStudyRecord

  # Public Subnet ã«ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é–¢é€£ä»˜ã‘
  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  # Private Route Table
  #  VPC å†…ã§ä½¿ã†Privateãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹(å¿…è¦ã«å¿œã˜ã¦ NAT çµŒç”±ã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚‚ç®¡ç†)
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref TsStudyRecordVPC
      Tags:
        - Key: Name
          Value: rt-private-ts-study-record

  # Private Subnet A ã«ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é–¢é€£ä»˜ã‘
  PrivateSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetA
      RouteTableId: !Ref PrivateRouteTable

  # Private Subnet C ã«ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é–¢é€£ä»˜ã‘
  PrivateSubnetCRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetC
      RouteTableId: !Ref PrivateRouteTable

# Security Group:-----------------------------------------------------------------------------------
  # http-https-sg-ts-study-record / Webã‚µãƒ¼ãƒç”¨
  HttpHttpsSgTsStudyRecord:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP and HTTPS access
      VpcId: !Ref TsStudyRecordVPC
      Tags:
        - Key: Name
          Value: http-https-sg-ts-study-record
      # ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0

  # WebServer â†’ RDS (PostgreSQL 5432)
  # Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¢ã‚¯ã‚»ã‚¹ã€å›ºå®šIPä¸è¦
  # RDS SG: WebserverRdsSgTsStudyRecord ã« WebServer SG ã‚’æŒ‡å®š

  # Bastion â†’ RDS (PostgreSQL 5432)
  # é‹ç”¨è€…ç”¨ã‚¢ã‚¯ã‚»ã‚¹ã€Bastion SG ã¾ãŸã¯å›ºå®šIPã‹ã‚‰ã®ã¿è¨±å¯
  # RDS SG: WebserverRdsSgTsStudyRecord ã« Bastion SG / å›ºå®šIPã‚’æŒ‡å®š

  # WebServer â†’ Backend API (ãƒãƒ¼ãƒˆ 4000)
  # Webã‚µãƒ¼ãƒã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯
  # APIå´ SG: BackendApiSg ã« WebServer SG ã‚’æŒ‡å®š
  WebserverRdsSgTsStudyRecord:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow DB access from WebServer and Bastion only
      VpcId: !Ref TsStudyRecordVPC
      Tags:
        - Key: Name
          Value: webserver-rds-sg-ts-study-record
      SecurityGroupIngress:
        # WebServer â†’ RDS (PostgreSQL)
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref HttpHttpsSgTsStudyRecord
        # Bastion â†’ RDS (PostgreSQL)
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          # - IPãŒæœªç¢ºå®šã¾ãŸã¯å¤‰æ›´ã®å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆã¯ã€ä¸€æ™‚çš„ã« `CidrIp: 0.0.0.0/0` ã§å…¨è¨±å¯ã—ã€å¾Œã‹ã‚‰æ‰‹å‹•ã§ä¿®æ­£ã™ã‚‹ã€‚
          # - å›ºå®šIPãŒæ±ºã¾ã£ãŸã‚‰ `CidrIp: <å›ºå®šIP>/32` ã«å¤‰æ›´ã™ã‚‹ã€‚
          # - ã¾ãŸã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—åŒå£«(BastionWebserverSgTsStudyRecord)ã§ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚‹ï¼ˆã“ã®å ´åˆã¯SGä½œæˆå¾Œã«è¨­å®šï¼‰ã€‚
          CidrIp: 0.0.0.0/0
        # WebServer â†’ Backend API (ãƒãƒ¼ãƒˆ4000)
        - IpProtocol: tcp
          FromPort: 4000
          ToPort: 4000
          SourceSecurityGroupId: !Ref HttpHttpsSgTsStudyRecord

  # ğŸ” SSHã‚¢ã‚¯ã‚»ã‚¹æ‰‹é †
  # 1. AWS ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ« â†’ EC2 â†’ ã‚­ãƒ¼ãƒšã‚¢ â†’ ã€Œã‚­ãƒ¼ãƒšã‚¢ã‚’ä½œæˆã€
  # 2. ä¾‹: ts-study-bastion-key ã¨ã„ã†åå‰ã‚’ä½œæˆ
  # 3. ä½œæˆæ™‚ã« .pem ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ­ãƒ¼ã‚«ãƒ«PCã«è‡ªå‹•çš„ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ï¼ˆå†å–å¾—ä¸å¯ï¼‰
  # 4. ä¸‹è¨˜ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã® "EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæ™‚"ã«ã€ãã®ã‚­ãƒ¼ãƒšã‚¢åã‚’ `KeyName` ã«æŒ‡å®šã—ã¦SSHæ¥ç¶šã‚’è¡Œã†

  # bastion-webserver-sg-ts-study-record / Security Group for Bastion/WebServer
  # SSH æ¥ç¶šå°‚ç”¨ï¼ˆPEMãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ­ãƒ¼ã‚«ãƒ«PCã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ï¼‰
  BastionWebserverSgTsStudyRecord:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: SSH access for Bastion/WebServer, outbound for SSH and PostgreSQL
      VpcId: !Ref TsStudyRecordVPC
      Tags:
        - Key: Name
          Value: bastion-webserver-sg-ts-study-record
      # ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0  # PEMã§æ¥ç¶šã™ã‚‹ã®ã§å…¨IPã‹ã‚‰å¯
      # ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰
      SecurityGroupEgress:
        # SSH
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        # PostgreSQL
        # psql ã‚„ pgAdmin ãªã©ã§ SQL ã‚’ç›´æ¥å®Ÿè¡Œã—ãŸã„ã¨ãã‚„ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚„ãƒªã‚¹ãƒˆã‚¢ä½œæ¥­ã€ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ãªã©
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          DestinationSecurityGroupId: !Ref WebserverRdsSgTsStudyRecord

# ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹:-----------------------------------------------------------------------------------
  # Web Server
  WebServerEC2:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.small
      ImageId: !Ref 'LatestAmiId'
      SubnetId: !Ref PublicSubnet
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref HttpHttpsSgTsStudyRecord
      UserData:
        Fn::Base64: |
          #!/bin/bash
          yum update -y
          amazon-linux-extras install -y nginx1
          systemctl enable nginx
          systemctl start nginx
          mkdir -p /home/ec2-user/ts-study-record-aws/frontend/dist
          echo "<h1>Hello from Nginx WebServer</h1>" > /home/ec2-user/ts-study-record-aws/frontend/dist/index.html
      Tags:
        - Key: Name
          Value: ec2-web-ts-study-record

  # ğŸ” SSHã‚¢ã‚¯ã‚»ã‚¹æ‰‹é †
  # 1. AWS ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ« â†’ EC2 â†’ ã‚­ãƒ¼ãƒšã‚¢ â†’ ã€Œã‚­ãƒ¼ãƒšã‚¢ã‚’ä½œæˆã€
  # 2. ä¾‹: ts-study-bastion-key ã¨ã„ã†åå‰ã‚’ä½œæˆ
  # 3. ä½œæˆæ™‚ã« .pem ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ­ãƒ¼ã‚«ãƒ«PCã«è‡ªå‹•çš„ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ï¼ˆå†å–å¾—ä¸å¯ï¼‰
  # 4. ä¸‹è¨˜ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã® "EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæ™‚"ã«ã€ãã®ã‚­ãƒ¼ãƒšã‚¢åã‚’ `KeyName` ã«æŒ‡å®šã—ã¦SSHæ¥ç¶šã‚’è¡Œã†

  # Bastion Host
  # EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ã€Security Group ãŒä½œæˆæ¸ˆã¿ã§ã‚ã‚‹å¿…è¦ã‚ã‚Š
  # Subnetï¼ˆPublicSubnetï¼‰ã‚‚ä½œæˆæ¸ˆã¿ã§ã‚ã‚‹å¿…è¦ã‚ã‚Š
  BastionEC2:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.micro  # ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—
      ImageId: !Ref 'LatestAmiId'  # Amazon Linux 2023 ã® AMI ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æŒ‡å®š
      SubnetId: !Ref PublicSubnet
      SecurityGroupIds:
        - !Ref BastionWebserverSgTsStudyRecord  # SSH å°‚ç”¨ SG
      KeyName: !Ref KeyPairName
      Tags:
        - Key: Name
          Value: bastion-ec2-ts-study-record

  # PostgreSQL æ¥ç¶šURLï¼ˆBastion çµŒç”±ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”¨ï¼‰
  # ssh -i ~/.ssh/yyy.pem -L 5432:<RDSã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ>:5432 ec2-user@bastion.xxx.com
  # åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰ localhost:5432 ã«æ¥ç¶šã—ã¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¯èƒ½
  DbTsStudyRecord:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: db-ts-study-record
      AllocatedStorage: 20 # ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ï¼ˆGBï¼‰
      DBInstanceClass: db.t4g.micro
      Engine: postgres
      MasterUsername: admin
      # MasterUserPassword ã¯ AWSãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰Secrets Manager ã«è¨˜è¼‰ã—ã€å‚ç…§ã™ã‚‹
      MasterUserPassword: '{{resolve:secretsmanager:rds-master-password:SecretString:password}}'
      VPCSecurityGroups:
        - !Ref WebserverRdsSgTsStudyRecord
      DBSubnetGroupName: !Ref RDSSubnetGroup
      # MultiAZ: true ã®å ´åˆã€ã‚¹ã‚¿ãƒ³ãƒã‚¤ã¯è‡ªå‹•ã§ç•°ãªã‚‹ AZ ã«é…ç½®ã•ã‚Œã‚‹
      # ã‚µãƒ–ãƒãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆDBSubnetGroupNameï¼‰ã§è¤‡æ•°AZã®ã‚µãƒ–ãƒãƒƒãƒˆã‚’æŒ‡å®šã—ã¦ã„ã‚Œã°ã€RDSãŒè‡ªå‹•ã§AZã‚’é¸æŠ
      MultiAZ: true
      PubliclyAccessible: false
      Port: 5432
      # AvailabilityZone: ap-northeast-1c

# Route53:-----------------------------------------------------------------------------------
  # Route53 Hosted Zone
  # ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ç”¨ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ã‚’ä½œæˆ
  MyHostedZone:
    Type: AWS::Route53::HostedZone
    Properties:
      Name: your-domain.com  # â† å®Ÿéš›ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åã«ç½®ãæ›ãˆ
      HostedZoneConfig:
        Comment: Hosted Zone for sample environment

  # Aãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆAddress Recordï¼‰ 
  # DNSï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ãƒãƒ¼ãƒ ã‚·ã‚¹ãƒ†ãƒ ï¼‰ã§ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³åã€ã‚’ã€ŒIPv4ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã«å¯¾å¿œä»˜ã‘ã‚‹

  # Aãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆWebã‚µãƒ¼ãƒãƒ¼ç”¨ï¼‰
  WebServerARecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref MyHostedZone
      Name: www.your-domain.com  # â† ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³åã«ç½®ãæ›ãˆ
      Type: A
      TTL: 300
      ResourceRecords:
        - !GetAtt WebServerEC2.PublicIp

  # Aãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ«ãƒ¼ãƒˆãƒ‰ãƒ¡ã‚¤ãƒ³ç”¨ï¼‰
  RootARecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref MyHostedZone
      Name: your-domain.com  # â† å®Ÿéš›ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åã«ç½®ãæ›ãˆ
      Type: A
      TTL: 300
      ResourceRecords:
        - !GetAtt WebServerEC2.PublicIp

  # Aãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆBastionã‚µãƒ¼ãƒãƒ¼ç”¨ï¼‰
  BastionARecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref MyHostedZone
      Name: bastion.your-domain.com  # â† ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³åã«ç½®ãæ›ãˆ
      Type: A
      TTL: 300
      ResourceRecords:
        - !GetAtt BastionEC2.PublicIp

  # CNAMEãƒ¬ã‚³ãƒ¼ãƒ‰ (Canonical Name Record)
  # ç‰¹å®šã®ãƒ‰ãƒ¡ã‚¤ãƒ³åï¼ˆä¾‹: db.home.example.comï¼‰ã‚’ã€
  # RDSãªã©ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆä¾‹: db-xxxx.ap-northeast-1.rds.amazonaws.comï¼‰ã«ç´ä»˜ã‘ã‚‹DNSãƒ¬ã‚³ãƒ¼ãƒ‰

  # CNAMEãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆDBã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç”¨ï¼‰
  DBCnameRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref MyHostedZone
      Name: db.home.your-domain.com  # â† ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³åã«ç½®ãæ›ãˆ
      Type: CNAME
      TTL: 300
      ResourceRecords:
        - !GetAtt DbTsStudyRecord.Endpoint.Address

  # homeã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ç”¨ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³
  HomeHostedZone:
    Type: AWS::Route53::HostedZone
    Properties:
      Name: home.your-domain.com  # â† å®Ÿéš›ã®ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ç½®ãæ›ãˆ
      HostedZoneConfig:
        Comment: Hosted Zone for home subdomain

  # db.homeç”¨ã®CNAMEãƒ¬ã‚³ãƒ¼ãƒ‰
  DbHomeCnameRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HomeHostedZone
      Name: db.home.your-domain.com  # â† å®Ÿéš›ã®FQDNã«ç½®ãæ›ãˆ
      Type: CNAME
      TTL: 300
      ResourceRecords:
        - db-xxxxxxx.ap-northeast-1.rds.amazonaws.com  # â† RDSã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ç½®ãæ›ãˆ

# Outputs:-----------------------------------------------------------------------------------
Outputs:
  # Webã‚µãƒ¼ãƒã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IP
  WebServerPublicIP:
    Description: Public IP of WebServer
    Value: !GetAtt WebServerEC2.PublicIp

  # Bastionã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IP
  BastionPublicIP:
    Description: Public IP of Bastion Host
    Value: !GetAtt BastionEC2.PublicIp

  # RDSã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆæ¥ç¶šç”¨ï¼‰
  DbEndpoint:
    Description: RDS endpoint address
    Value: !GetAtt DbTsStudyRecord.Endpoint.Address

  # RDSãƒãƒ¼ãƒˆ
  DbPort:
    Description: RDS port
    Value: !GetAtt DbTsStudyRecord.Endpoint.Port

  # Route53 Hosted Zone ID
  HostedZoneID:
    Description: Route53 Hosted Zone ID
    Value: !Ref MyHostedZone

  # Elastic IPã‚’ä½¿ã†å ´åˆã®å‡ºåŠ›ä¾‹ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
  # æœ¬ã‚’è¦‹ã‚‹é™ã‚ŠElastic IPã¯ä½¿ã£ã¦ã„ãªã„ã‚ˆã†ãªã®ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
  # WebServerElasticIP:
  #   Description: Elastic IP of WebServer
  #   Value: !Ref WebServerElasticIP

